<!DOCTYPE html>
<html>
<head>
	<title>GeoMixer Vector Layer Animation</title>
	<meta charset="utf-8" />
    <style>
        html, body {
            height: 100%;
            margin: 0px;
        }
		
        #controls {
            position: absolute;
			left: 54px;
			top: 11px;
			z-index: 1;
			background-color: #ffffff;
			padding: 13px 15px 13px 13px;
			border-radius: 5px;
            box-shadow: 0 1px 7px rgba(0,0,0,0.65);
        }
		
		#slider {
			width: 300px;
		}
		#timeInfo {
			text-align: center;
			padding-top: 12px;
		}
		#auto {
            display: none;
		}
        
    </style>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet-src.js"></script>
    <script src="http://scanex.github.io/Leaflet-GeoMixer/build/leaflet-geomixer-dev.js?key=U92596WMIH"></script>

	<script type="text/javascript" src="webgl-heatmap.js"></script>
	<script type="text/javascript" src="webgl-heatmap-leaflet.js"></script>
	
    
	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
</head>
<body>
	<div id="controls">
		<div id="slider"></div>
		<div id="timeInfo"><span id="curDate">Loading data...</span><span id="auto"><input type="checkbox" id="autochkbox" /> auto</span></div>
	</div>

	<div id="map" style="width: 100%; height: 100%"></div>
	
	<script>
		var map = L.map('map').setView([0, 0], 2);

		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
		}).addTo(map);

        //map.setView([44.68, -63.62], 12);
        //map.scrollWheelZoom.disable();
    
        //custom size for this example, and autoresize because map style has a percentage width
        var heatmap = new L.TileLayer.WebGLHeatMap({size: 1000, autoresize: true}); 
/*
        var dataPoints = [[50.880509986,-114.081560859],[50.880509986,-114.081560859],[50.880509986,-114.081560859],[44.53666687,-64.243164062],[44.639999389,-63.613998413],[44.676998138,-63.612499237],[44.679332733,-63.610500335],[50.970165252,-114.06916809],[34.104833333,-118.323],[50.579812463,-113.872800754],[51.055080414,-114.056716919],[44.648111204,-63.577139396],[44.642322778,-63.579243422],[44.643284609,-63.568868637],[44.64246,-63.578947],[44.718542104,-63.683588477],[44.718418471,-63.683593422],[44.718461344,-63.683637427],[44.718412771,-63.683782686],[44.718390978,-63.683674224],[44.718426894,-63.683400638],[44.718389102,-63.683563615],[44.643199507,-63.568366686],[44.718326605,-63.683847729],[44.7157814,-63.686402518],[44.718411484,-63.683636892],[44.718421013,-63.683612197],[44.718408703,-63.683583046],[44.718479198,-63.683512285],[44.718442462,-63.683621787],[44.70944854,-63.693567955],[44.718409395,-63.683602933],[44.718338801,-63.684254335],[44.718401488,-63.683540924],[44.718386997,-63.683626363],[44.718386997,-63.683626363],[44.718386997,-63.683626363],[44.717759553,-63.677263503],[44.642686,-63.578319],[44.718392151,-63.683523433],[44.718386997,-63.683626363],[44.718355229,-63.683762904],[44.718500027,-63.683851836],[44.718399905,-63.683797438],[44.718426224,-63.683320424],[44.647744146,-63.575160526],[44.642261709,-63.579683304],[44.649856,-63.586578],[44.647437,-63.580284],[44.718402168,-63.683638014],[44.718503631,-63.68352226],[44.718453507,-63.683740692],[44.718406694,-63.683453947],[44.718592538,-63.683768395],[44.718500529,-63.68364891],[44.718374717,-63.683847142],[44.718296221,-63.683787212],[44.718322533,-63.683521553],[44.718461344,-63.683620161],[44.718429676,-63.683640406],[44.71843339,-63.683663914],[44.718477647,-63.683813028],[44.718398396,-63.683542209],[44.718504084,-63.683465428],[44.718575212,-63.683621166],[44.718387784,-63.683589918],[44.718244917,-63.683892581],[44.718385838,-63.683624545],[44.718397606,-63.683539988],[44.718408668,-63.683616944],[44.718401751,-63.683572637],[44.718407164,-63.683572267],[44.718424391,-63.683666915],[44.718339513,-63.683889806],[44.718404213,-63.683593903],[44.718376712,-63.683603459],[44.718365334,-63.683625158],[44.718406172,-63.683623469],[44.718357136,-63.683653095],[44.71841303,-63.683625434],[44.718367131,-63.683636757],[44.718337501,-63.683804059],[44.718377546,-63.683478126],[44.718491649,-63.68370368],[44.718393032,-63.683595266],[44.718385449,-63.683592853],[44.556,-63.563833333],[44.671740616,-63.660832197],[44.671699377,-63.660803614],[44.650516667,-63.634983333],[44.682657157,-63.581371625],[44.652560615,-63.637365109],[44.662666667,-63.6345],[44.718390166,-63.683674139],[51.0549761,-114.0566049],[44.647666667,-63.573333333],[44.648014329,-63.573271877],[44.648554538,-63.574344579],[44.647997223,-63.573241235],[44.648057524,-63.573333219],[44.651147986,-63.58592016],[44.648053095,-63.573335837],[44.648049961,-63.573337555],[44.647992428,-63.57324009],[44.65103244,-63.586054136],[44.647998691,-63.573239491],[44.673508569,-63.610356879],[44.673482205,-63.610403717],[44.647985685,-63.573243277],[44.651148375,-63.586018439],[44.648188702,-63.574800331],[44.6475,-63.5735],[44.648166667,-63.573166667],[44.718394708,-63.683590405],[44.71838377,-63.683576826],[44.718394415,-63.683546316],[44.718268689,-63.683666691],[44.71864759,-63.683303157],[44.71850472,-63.683727449],[44.647948211,-63.573278864],[44.647947569,-63.573240346],[44.651025485,-63.586162306],[44.648015089,-63.573220559],[44.718304519,-63.683675313],[44.6479849,-63.573133935],[44.718260807,-63.683954179],[44.718255149,-63.684004387],[44.648027867,-63.573121066],[44.649337748,-63.573835785],[44.648518807,-63.572818333],[44.646348072,-63.579521767],[44.6825,-63.362166667],[44.648050795,-63.573207514],[44.642365385,-63.579069563],[44.647666667,-63.573666667],[44.648047005,-63.57320867],[44.651097756,-63.585969862],[44.647750911,-63.572166638],[44.651025169,-63.586115739],[44.647971759,-63.573231614],[44.647987359,-63.573132502],[44.718419438,-63.683311466],[44.718472408,-63.683654778],[44.718394247,-63.683585459],[44.718410382,-63.683658717],[44.651039437,-63.58614489],[44.718225016,-63.683936577],[44.718481251,-63.683596272],[44.718583343,-63.683534749],[44.718619091,-63.683420336],[44.718373712,-63.683545037],[44.718396437,-63.683633034],[44.648759853,-63.571901234],[44.644068182,-63.603407172],[44.648041216,-63.573117523],[44.71836705,-63.683475952],[44.718344311,-63.68345068],[44.718334822,-63.683397432],[44.647986456,-63.573130125],[44.671671046,-63.660505681],[44.651169857,-63.58613894],[44.647949152,-63.573143106],[44.6367824,-63.5696974],[44.648833333,-63.575666667],[44.647949219,-63.573143005],[44.648004845,-63.573415014],[44.650751104,-63.586362192],[44.647995521,-63.573130487],[44.649417461,-63.573697006],[44.65011715,-63.571854848],[44.648184301,-63.57313115],[44.648333333,-63.573833333],[44.651488877,-63.586268688],[44.647995802,-63.573213963],[44.718422358,-63.68365475],[44.66293276,-63.56837079],[44.649856,-63.586578],[44.6485,-63.575333333],[44.6485,-63.573166667],[44.648833333,-63.576],[44.648666667,-63.575333333],[44.648333333,-63.573166667],[44.647958443,-63.573140511],[44.648166667,-63.573],[44.64801991,-63.573123893],[44.648,-63.575],[44.647992736,-63.573227064],[44.647959151,-63.573236916],[44.64795916,-63.57323695],[44.686,-63.576833333],[44.64794776,-63.573143352],[44.650999667,-63.58605429],[44.648020456,-63.57312407],[44.718418513,-63.683507089],[44.647166667,-63.578],[44.651203809,-63.586264202],[44.71818713,-63.683923837],[44.718442443,-63.683651509],[44.651061138,-63.586100408],[46.482973534,-63.364353629],[44.718406317,-63.683468616],[44.718295382,-63.683739351],[44.718661336,-63.68385368],[50.886746263,-113.9625415],[44.536610587,-64.241899661],[44.636670683,-64.070719107],[44.718642142,-63.683821494],[44.71843391,-63.683731334],[44.718555892,-63.683676738],[44.71839419,-63.683350862],[44.718374508,-63.683703225],[44.718404976,-63.68349812],[44.718551789,-63.68372264],[44.718432915,-63.683633424],[44.71837082,-63.683931967],[44.718291098,-63.682482006],[44.718192775,-63.682555591],[44.718291005,-63.682433297],[44.648166667,-63.5735],[44.648029573,-63.573119835],[44.7183704,-63.683466688],[44.718401874,-63.683598368],[44.718377776,-63.683538437],[44.718554886,-63.683577832],[44.71847048,-63.68354707],[44.647504888,-63.568862351],[44.718490681,-63.683815794],[44.7184393,-63.683784949],[44.718402084,-63.683651844],[44.718343159,-63.683663243],[44.650977935,-63.586143313],[44.647666667,-63.569333333],[44.718425898,-63.683625393],[44.648072445,-63.573763048],[44.718434354,-63.683361914],[44.648333333,-63.574],[44.648041772,-63.573219836],[44.647983139,-63.57324332],[44.718406065,-63.683673721],[44.718379998,-63.683725018],[46.157528549,-60.181348287],[46.15754569,-60.18136153],[44.647666667,-63.570333333],[44.646348072,-63.579521767],[46.157391211,-60.181346862],[44.64814875,-63.573510736],[44.647948196,-63.573337936],[44.647989629,-63.573314422],[44.718409134,-63.683591071],[44.647949785,-63.573338185],[44.641,-63.559666667],[44.647949198,-63.573337529],[44.647949219,-63.573337555],[44.647666667,-63.570166667],[44.718552958,-63.683496192],[44.648012839,-63.573300857],[44.71839102,-63.683765922],[44.718617708,-63.683265271],[44.718380389,-63.683573888],[44.650987788,-63.586160445],[44.647993689,-63.573317209],[44.6385797,-63.581365285],[44.647947693,-63.573338317],[44.637912993,-63.570022173],[44.718402461,-63.683588719],[44.718381275,-63.683627356],[44.718391268,-63.683598516],[44.728879861,-63.662494157],[44.649681144,-63.588888645],[44.728690811,-63.662837517],[44.728986584,-63.661827631],[44.734289898,-63.656625738],[44.718388846,-63.683494769],[44.718406821,-63.683618683],[44.718382221,-63.683546691],[44.718359444,-63.683568169],[44.718484101,-63.683662573],[44.718365155,-63.683571516],[44.718394443,-63.683632021],[44.718394289,-63.683814621],[44.718422777,-63.683598836],[44.718424128,-63.683701046],[44.71843288,-63.683620999],[44.718435737,-63.683737507],[44.71853062,-63.683763491],[44.718360959,-63.683574422],[44.71837016,-63.683590646],[44.718348456,-63.683634479],[44.718397382,-63.683637933],[44.718421792,-63.683623621],[44.718411775,-63.68362993],[44.718413196,-63.683624713],[44.718389958,-63.683576335],[44.629577865,-63.59709124],[44.718339052,-63.68366601],[44.718391439,-63.683870696],[44.648060176,-63.573257092],[44.648006407,-63.573280856],[44.647957045,-63.57333199],[44.647953867,-63.573345395],[44.647949219,-63.573337555],[44.647953147,-63.573343265],[44.657612595,-63.598755226],[44.64800926,-63.57329508],[44.647,-63.570833333],[44.649711,-63.576463],[44.648014779,-63.573297491],[44.648142977,-63.574627756],[44.649711,-63.576463],[44.650977753,-63.586177734],[44.648166667,-63.575],[44.649,-63.579],[44.6485,-63.573166667],[44.648543077,-63.572295292],[44.648731,-63.575203],[44.648046078,-63.574006911],[44.651083621,-63.586298995],[44.651306032,-63.585846049],[44.647947529,-63.573338109],[44.648077544,-63.573043104],[44.648146931,-63.574341309],[44.647949219,-63.573337555],[44.648015318,-63.573290721],[44.650833333,-63.585666667],[44.648008122,-63.573278663],[44.6475,-63.575833333],[44.648333333,-63.573166667],[44.648276159,-63.573678422],[44.648009564,-63.573482037],[44.648166667,-63.574],[44.648310553,-63.573226405],[44.648731,-63.575203],[44.648731,-63.575203],[44.6485,-63.573666667],[44.64902473,-63.576464653],[44.646234,-63.573501],[44.64949,-63.573583],[44.647333333,-63.573833333],[44.647024333,-63.574757507],[44.64888917,-63.572066591],[44.648731,-63.575203],[44.647952642,-63.573144374],[44.647166667,-63.577333333],[44.648337778,-63.573052883],[44.650514706,-63.587922501],[44.651144316,-63.586260171],[44.649628,-63.618182],[44.6461762,-63.57394416],[44.648142977,-63.574627756],[44.648142977,-63.574627756],[44.650047511,-63.573074341],[44.647960591,-63.573202266],[44.650760111,-63.581492722],[44.648041187,-63.573906955],[44.647975399,-63.573285099],[44.648248334,-63.576481577],[44.647930833,-63.573688857],[44.647391296,-63.577537537],[44.648446633,-63.575332696],[44.648731,-63.575203],[44.648731,-63.575203],[44.646169908,-63.574938447],[44.650948378,-63.586219386],[44.648731,-63.575203],[44.649207916,-63.574490547],[44.647476456,-63.572821122],[44.644218327,-63.573323947],[44.648166667,-63.573666667],[44.6485,-63.577666667],[44.647391296,-63.577537537],[44.649510631,-63.574474847],[44.648666667,-63.577666667],[44.648833333,-63.573333333],[44.648242588,-63.573483794],[44.648025744,-63.573888466],[44.648,-63.573833333],[44.64858012,-63.573396206],[44.648067408,-63.574063495],[44.647999844,-63.573249421]];

        for (var i = 0, len = dataPoints.length; i < len; i++) {
            var point = dataPoints[i];
            heatmap.addDataPoint(point[0],
                 point[1],
                 50);
        }
*/
        /* 
        *  alternatively, if you have intensities set for each point, 
        *  as in above, you can skip the for loop and add the whole dataset 
        *  with heatmap.setData(dataPoints) 
        */
        
        map.addLayer(heatmap);

		var updateInfo = function(currentDate) {
			var zz = function(x) { return x < 10 ? "0" + x : x}
			var dateStr = zz(currentDate.getUTCDate()) + '.' + zz(currentDate.getUTCMonth() + 1) + '.' + zz(currentDate.getUTCFullYear());
			document.getElementById('curDate').innerHTML = dateStr;
		}
		
		var startDate = new Date('2013/11/01'),
            oneDay = 1000*60*60*24,	// milliseconds in one day
            now = startDate.getTime(),
            ddt1 = new Date( now - now % oneDay - oneDay), //beginning of the UTC day
            ddt2 = new Date(ddt1.getTime() + 20*oneDay);
		
		var items = {};
        L.gmx.loadLayer('AZR6A', 'C13B4D9706F7491EBC6DC70DFFA988C0', {
            beginDate: new Date(ddt2.valueOf() - oneDay),
            endDate: ddt2
        }).then(function(hotspotLayer) {
            var observer = hotspotLayer.addObserver({
                callback: function(data) {
                    var dataPoints = [];
                    for (var i = 0, len = data.added.length; i < len; i++) {
                        var vectorTileItem = data.added[i],
                            id = vectorTileItem.id,
                            latlng = items[id];
                        if (!latlng) {
                            var item = vectorTileItem.properties,
                                geo = item[item.length - 1],
                                p = geo.coordinates,
                                latlngPoint = L.Projection.Mercator.unproject({x: p[0], y: p[1]});

                            latlng = [latlngPoint.lat, latlngPoint.lng, item[2] * 4];
                            items[id] = latlng;
                        }
                        dataPoints.push(latlng);
                    }
                    heatmap.setData(dataPoints);
                    heatmap.update();
                    
                    //console.log('observer', latlngs.length);
                }
                ,type: 'resend'
              });
            var updateBbox = function() {
                var screenBounds = map.getBounds(),
                    p1 = screenBounds.getNorthWest(),
                    p2 = screenBounds.getSouthEast(),
                    bbox = gmxAPIutils.bounds([[p1.lng, p1.lat], [p2.lng, p2.lat]]);
                observer.setBounds(bbox);
            };
            map.on('moveend', updateBbox);

            var nextDay = function(val) {
                updateInfo(new Date(val - oneDay));
                hotspotLayer.setDateInterval(new Date(val - oneDay), new Date(val));
                observer.setDateInterval(new Date(val - oneDay), new Date(val));
            }
			hotspotLayer._gmx.dataManager.preloadTiles(ddt1, ddt2).then(function() {
				updateInfo(new Date(ddt2.valueOf() - oneDay));
				//hotspotLayer.addTo(map);
                document.getElementById('auto').style.display = 'inline';
				$('#slider').slider({
					min: ddt1.valueOf() + oneDay,
					max: ddt2.valueOf(),
					step: oneDay,
					value: ddt1.valueOf(),
					slide: function(event, ui) {
                        nextDay(ui.value);
					}
				});
                var autoTimer = null;
                var autochkbox = document.getElementById('autochkbox');
                autochkbox.onchange = function(event) {
                    if (autochkbox.checked) {
                        autoTimer = setInterval(function(event, ui) {
                            var zn = $('#slider').slider("value");
                            if (zn == ddt2.valueOf()) zn = ddt1.valueOf();
                            zn += oneDay;
                            $('#slider').slider("value", zn);
                            nextDay(zn);
                        }, 0);
                    } else {
                        clearInterval(autoTimer);
                    }
                }
			});
        })

	</script>
</body>
</html>