<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<script src="http://localhost/api/api.js?key=U92596WMIH" charset="windows-1251"></script> 
	<title>GeoMixer API - примеры использования</title>
</head>
<body>
<div id="map_container" style="width: 800px; height: 650px; float: left;"></div> <!--задаем контейнер, в который загружается карта -->
<script> 
	createFlashMap(document.getElementById("map_container"), function(map)
	{
		map.moveTo(132.17102, 60.519149, 7);
		var apiFolder = gmxAPI.getAPIFolderRoot();

		gmxAPI.loadVariableFromScript(
			'gmxAPIUtils.js', 
			"gmxAPIutils",
			function(ph) {	runMe(ph); },
			function(ph) {	alert(ph); }
		);
		
		var runMe = function(ph) {
			var gmxAPIutils = ph;
			//alert(ph);
var flag = gmxAPIutils.isTileKeysIntersects({'z': 2, 'x': 0, 'y': -2}, {'z': 4, 'x': 1, 'y': -5});
console.log('isTileKeysIntersects: ' , flag);
//return;
			var hostName = 'maps.kosmosnimki.ru';
			var apikeyRequestHost = window.apikeyRequestHost  ? window.apikeyRequestHost  : "maps.kosmosnimki.ru";
			var apiKey = gmxAPI.getAPIKey();
			gmxAPIutils.getSessionKey(
				{
					'url': "http://" + apikeyRequestHost + "/ApiKey.ashx?WrapStyle=None&Key=" + apiKey
				}, function(ph) {
					if(ph && ph['Status'] === 'ok') {
						runMe1(ph['Result']['Key']);
					}
					//console.log('getSessionKey: ' , ph);
			});
			var runMe1 = function(skey) {
			
				var sessionKey = skey;
				var mapName = 'UIRCQ';
				//var layerTitle = 'test4List', layerName = 'B0A30EF77D7F4182B302B9F7CB83CA25';
				var layerTitle = 'Деревья в районе "Воробьевы горы - МГУ"', layerName = 'DF8D098FB3A44C4D8A76037D5FAC3A5C';
				var layerTitle = 'testPoint12', layerName = '3CF53D01EE9E4C5EA38F72A82866EFAD';
				var tileSenderPrefix = "http://" + hostName + "/" + 
					"TileSender.ashx?WrapStyle=None" + 
					(sessionKey ? ("&key=" + encodeURIComponent(sessionKey)) : "")
					//+ (mapSessionKey ? ("&MapSessionKey=" + mapSessionKey) : "")
					;
				/*var pt = {
					'tileSenderPrefix': 'vectorData'
					,'hostName': hostName
					,'mapName': mapName
					,'key': key
					,'mapSessionKey': mapSessionKey
					,'layerName': layerName
					,'observeType': 'onVisible'
					,'geomType': 'mercator'
					,'currPosition': gmxAPI.currPosition
				};
				gmxAPIutils.getMapPropreties(
					{
						'tileSenderPrefix': tileSenderPrefix + "&MapName=" + mapName
					}, function(ph) {
					console.log('getMapPropreties: ' , ph);
				});*/
				gmxAPIutils.getLayerPropreties(
					{
						'tileSenderPrefix': tileSenderPrefix
						,'mapName': mapName
						,'layerName': layerName
					}, function(ph) {
						var res = gmxAPIutils.prepareLayerBounds(ph);
						res['tileSenderPrefix'] = tileSenderPrefix;
						res['mapName'] = mapName;
						res['layerName'] = layerName;

						console.log('getLayerPropreties: ' , ph);
						console.log('prepareLayerBounds: ' , res);
						var oneDay = 1000*60*60*24;	// один день
						var dt2 = new Date(new Date().getTime() + 3 * oneDay)
						var dt1 = new Date(dt2.getTime() - 701 * oneDay)
						var res1 = gmxAPIutils.getNeedTiles(res, dt1, dt2, res);
						console.log('getNeedTiles: ' , res1);
						var gmxTilePoint = {'z': 1, 'x': 0, 'y': 0};
						//var gmxTilePoint = {'z': 17, 'x': 13670, 'y': 24422};
						var cnt = gmxAPIutils.loadTile(res, gmxTilePoint, function(ph) {
							console.log('loadTile: ' , ph);
						});
						console.log('loadTile cnt: ' , cnt);
						
				});
			}
		};
/* 17_13670_24422
		if('_leaflet' in gmxAPI && 'addWorker' in gmxAPI._leaflet) {
			//dataWorker = gmxAPI._leaflet.addWorker(apiFolder + "leaflet/ExternalVectorDataProvider.js?" + gmxAPI.buildGUID); 
			dataWorker = gmxAPI._leaflet.addWorker(apiFolder + "leaflet/ExternalVectorDataProvider.js?" + String(Math.random())); 

			var curRes = {};
			var hostName = 'maps.kosmosnimki.ru';
			var mapName = 'UIRCQ';
			//var layerTitle = 'test4List', layerName = 'B0A30EF77D7F4182B302B9F7CB83CA25';
			//var layerTitle = 'Деревья в районе "Воробьевы горы - МГУ"', layerName = 'DF8D098FB3A44C4D8A76037D5FAC3A5C';
			var layerTitle = 'testPoint12', layerName = '3CF53D01EE9E4C5EA38F72A82866EFAD';
			
			//var layerName = map.layers[layerTitle].properties.name;
			
			var key = window.KOSMOSNIMKI_SESSION_KEY;
			var mapSessionKey = ('sessionKeyCache' in window ? window.sessionKeyCache[mapName] : false);
			var pt = {
				'cmd': 'vectorData'
				,'hostName': hostName
				,'mapName': mapName
				,'key': key
				,'mapSessionKey': mapSessionKey
				,'layerName': layerName
				,'observeType': 'onVisible'
				,'geomType': 'mercator'
				,'currPosition': gmxAPI.currPosition
			};
			dataWorker.send(pt, function(ph) {
				var timeStamp = new Date().getTime();
				for (var i = 0, len = ph['arr'].length; i < len; i++)
				{
					var item = ph['arr'][i];
					var tid = item['tid'];
					var onExtent = item['onExtent'];
					if(onExtent) curRes[tid] = item;
					else delete curRes[tid];
				}
				var cnt = 0;
				for (var key in curRes)
				{
					cnt++;
				}
				console.log('vectorData __ ' , cnt, ph['arr'].length, ph['arr']);
				console.log('timeStamp __ ' , timeStamp - ph.timeStamp1, ph.timeStamp1 - ph.timeStamp);
			}, {'notRemove': true});
			var onMoveEnd = function(ph) {
				var pt = {
					'cmd': 'onMoveEnd'
					,'extent': ph.attr.extent
					,'z': ph.attr.z
					,'x': ph.attr.x
					,'y': ph.attr.y
					,'mouseX': ph.attr.mouseX
					,'mouseY': ph.attr.mouseY
				};
				dataWorker.send(pt);
			}
			gmxAPI.map.addListener('onMoveEnd', onMoveEnd, 11);
		}
*/
	});
</script> 

</body>
</html>
